---
title: "Méthodologie pour attribuer un revenu aux ménages"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Ce document a pour objectif de proposer une méthode pour l'ajout de la variable revenue à une population synthétique qui ne contient pas cette variable. En revanche, il est connu les déciles de cette variable pour certains marginaux. Cette méthode est implémentée en R. Elle est donnée sous la forme d'un exemple qui permet de tester différentes méthodologies. Dans la suite, nous présentons le cas d'étude, puis la méthodologie et enfin son application sur le cas étudié.

# Le cas d'étude: 

sur l'iris, en faisant l'hypothèse de l'identité entre la personne de référende fiscale et la personne de référence du recensemsent, nous avons 20 ménages dont la personne de référence a entre 0 et 30 ans, 
70 qui ont entre 30 et 60 ans
et 10 qui sont supérieur à 60 ans.
pour ceux dont la personne de référende est entre 0 et 30 ans, les 9 déciles sont les valeurs suivantes se reproduisent ainsi
5000,  10000, 15000, 16000, 17000, 18000, 20000, 22000, 250000
pour ceux qui ont entre 30 et 60 ans, on augmente de 5000
et pour ceux qui sont à la retraite, on prend les 4 premiers déciles des jeunes et les 5 suivants des personnes actives


```
data_iris_age=data.frame(age=factor(),effectif=integer())
modalite_age=c('moins_de_30ans', '30-60ans','plus_de_60ans')
data_iris_age=rbind(data_iris_age,c(modalite_age[1],20), c(modalite_age[2],70), c(modalite_age[3],10))
colnames(data_iris_age)=c('age','effectif')


decile_0_30ans=c(5000,  10000, 15000, 16000, 17000, 18000, 20000, 22000, 25000)
carriere=5000
decile_30_60ans=decile_0_30ans+carriere
pauvre=1:4
riche=5:9
decile_60_100ans=c(decile_0_30ans[pauvre], decile_30_60ans[riche])

data_fisc_age=rbind(c(modalite_age[1],decile_0_30ans), c(modalite_age[2],decile_30_60ans), c(modalite_age[3],decile_60_100ans))
colnames(data_fisc_age)=c('age','d1','d2','d3','d4','d5','d6','d7','d8','d9')

```

sur l'iris, en faisant l'hypothèse de l'identité entre la personne de référende fiscale et la personne de référence du recensemsent, nous avons 10 ménages dont la taille de personne est 1
50 sont la taille est 2, 30 dont la taille est 3
et 10 qui sont supérieur à 3.
pour ceux dont la taille est 1  les 9 déciles sont les valeurs suivantes se reproduisent ainsi
5000,  10000, 15000, 16000, 17000, 18000, 20000, 22000, 250000 + 1000
pour ceux dont la taille est 2   on multiplie par 2
pour ceux dont la taille est 3   on augmente de 1000
pour ceux dont la taille est  supérieur à 3   on augmente de 1000
on prend les 4 premiers déciles de la taille 2 et les 5 suivants de la taille 3

```
data_iris_taille=data.frame(taille=factor(),effectif=integer())
modalite_taille=c('1', '2','3','4_et_plus')
data_iris_taille=rbind(data_iris_taille,c(modalite_taille[1],20), c(modalite_taille[2],50), c(modalite_taille[3],30), c(modalite_taille[4],10))
colnames(data_iris_taille)=c('taille','effectif')


decile_1=c(5000,  10000, 15000, 16000, 17000, 18000, 20000, 22000, 25000)+1000
decile_2=decile_1*2
decile_3=decile_2+1000
pauvre=1:4
riche=5:9
decile_4_et_plus=c(decile_1[pauvre], decile_3[riche])
data_fisc_taille=rbind(c(modalite_taille[1],decile_1), c(modalite_taille[2],decile_2), c(modalite_taille[3],decile_3),  c(modalite_taille[4],decile_4_et_plus))

colnames(data_fisc_taille)=c('taille','d1','d2','d3','d4','d5','d6','d7','d8','d9')
```


# Méthodologie

Note : dans la suite r signifie : le revenu est inférieur à r. a signie : l'age de la personne de référence du ménage est égale à la modalité a. t signifie la taille du ménage est égale à la modalité t. 

Nous souhaitos connaitre pour tout revenu, r,compris entre le revenu minimal, rmin, la probabilité que le revenu soit inférieur à r sachant que la taialle du ménage est t et l'age de la personne du ménage est a. Ce qui s'écrit mathématiquement :

$$ P(r \; | \; (\text{a et t})) $$
En appliquant le théorème de Bayes, nous obtenons

$$P(r \; | \; (\text{a et t}))=P((\text{a et t}) \; | \; r) \frac{P(r)}{P(\text{a et t})}$$
Une règle de trois sur la population synthétique permet  de connnaitre
$$P(\text{a et t})$$
La connaissance des déciles sur le revenu et la proportion de chacune des modalité permet de connaitre 
$$P(r_k) = \sum_i P(r_k| a_i)P(a_i)$$
rk est le revenu correspondant au décile k (k=0.1,0.2,0.3,...1), al correspont à la modalité l de l'age de la personne de référence du ménage

On peut aussi faire le calcul avec les modalités sur la taille : 

$$P(r_l) = \sum_j P(r_l| t_j)P(t_j)$$
Même si rk et rl sont différents, il est intéressant de calculer ces 20 valeurs pour vérifier visuellement leurs cohérences.

Ensuite, il faut estimer 
$$P((\text{a et t}) \; | \; r)$$
Pour cela, nous allons utiliserla méthodologie de l'entropie croisée : nous allons considérer que cette probabilité doit être la plus proche de P(a et t)
tout en respectant les déciles P(rl sachant ai) pour tout l et pour tout i et P(rk schant tj) pour tout k et pour tout j.

Nous allons calculer P( a et t sachant r) pour r valant rk ou rl. Sachant qu'il y a 20 déciles,  3 modalité pour l'age de la personne du référence du ménage et 4 modalités pour la taille du ménages, nous avons 240 degrés de libertés



Concrêtement, pour connaitre par exemple, P ((a et t) sachant r1) où r1 correspond au revenu du  premier décile lorsque l'age de référence est égale 

$$ Min \; \sum_{i,j,k,l} P(\text{ai et tj}) \; | \; r_{k,l})) ln(\frac{P(\text{a_i et t_j}))}{P(\text{a_i et t_j}) \; | \; r_{k,l})))}$$
sous les contraintes

$$P(r_k \; | \; a_i) =k\times 0.1$$
$$P(r_l \; | \; t_j) =l\times 0.1$$
soit 70 contraintes

Dans la suite, nous nous concentrons sur une contrainte pour voir sa relation avec les degrés de liberté:
$$P(r_1 \; | \; a_1) = P(a_1 \; | \; r_1)\frac{P(r_1)}{P(a_1)} $$ 
P(a1) est un maginal de la population synthétique. P(r1) a été calculé précedemment et P(a1 sachant r1) s'écrit en fonction des degrés de liberté:

$$P(a_1 \; | \; r_1) = P(a_1 \text{ et } b_1| \; r_1) + P(a_1 \text{ et } b_2| \; r_1) + P(a_1 \text{ et } b_3| \; r_1) + P(a_1 \text{ et } b_4 | \; r_1) $$


# Application

En cours de développement.... A faire avec Fabrice

```
R=20000
age=modalite_age[1]
taille=modalite_taille[1]
p=c(1:9)/10
data_iris_taille[modalite_taille[1],2:]
PRAge=data.frame(p)
```
